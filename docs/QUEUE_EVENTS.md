# Queue Event System

The bot automatically sends Discord notifications when queues pop and when check-ins timeout.

## Event Flow

### Queue Pop Event

When 4 players join the same league queue:

1. **Queue Service** emits a `queuePop` event
2. **Queue Event Handler** catches the event
3. **DM sent to each player** with:
   - Match details (scrim ID, league)
   - Player list
   - Map list (3 maps selected from least-played)
   - Check-in deadline (5 minutes)
   - Pre-filled Google Form link for result submission
4. **Optional**: Post to league-specific channel (if configured)

### Check-in Timeout Event

When the 5-minute check-in window expires and not all players have checked in:

1. **Queue Service** emits a `checkInTimeout` event
2. **Queue Event Handler** catches the event
3. **No-show players** receive:
   - Dodge penalty notification
   - Ban duration (escalating: 5min → 30min → 2hr)
   - Dodge count in last 24 hours
4. **Checked-in players** receive:
   - Match cancelled notification
   - Confirmation they're back in queue with priority

## Discord Notifications

### Queue Pop DM

```
⚠️ **SCRIM MATCH FOUND** ⚠️

You have **5 minutes** to check in using /checkin

[Embed with:]
- Scrim ID
- League
- 4 players
- 3 maps
- Check-in deadline
- Form submission link
```

### Dodge Penalty DM

```
[Embed with:]
- ❌ Queue Dodge Penalty
- Ban duration
- Recent dodge count
- Warning message
```

### Match Cancelled DM (for checked-in players)

```
[Embed with:]
- ⚠️ Match Cancelled
- Reason: not all players checked in
- ✅ Returned to queue with priority
```

## Optional Channel Notifications

You can configure dedicated scrim channels per league in your `.env`:

```env
SCRIM_CHANNEL_ACADEMY=123456789012345678
SCRIM_CHANNEL_CHAMPION=123456789012345678
SCRIM_CHANNEL_MASTER=123456789012345678
```

When configured, the bot will post scrim notifications to these channels in addition to DMs.

### Getting Channel IDs

1. Enable Developer Mode in Discord (Settings → Advanced → Developer Mode)
2. Right-click the channel → Copy Channel ID
3. Add to `.env`

## Implementation Details

### Queue Pop

File: [src/handlers/queueEvents.ts](../src/handlers/queueEvents.ts)

The handler:
- Fetches each player's Discord user object
- Sends DM with embed
- Generates pre-filled Google Form URL
- Optionally posts to scrim channel
- Logs all actions for debugging

### Check-in Timeout

The timeout is handled by:
- Queue service starts a 5-minute timer when scrim is created
- Timer callback checks if all players checked in
- If not, emits `checkInTimeout` event
- Event handler sends appropriate notifications

### Error Handling

- If a player has DMs disabled, the error is logged but doesn't stop other notifications
- Failed channel posts are logged but don't affect DMs
- All errors include player/scrim context for debugging

## Testing Queue Events

Since the seed data has fake Discord IDs, you can't test the full flow without real players. However, you can:

1. **Check logs** - Events are logged when emitted
2. **Modify seed data** - Update `db/seed.sql` with your real Discord ID
3. **Test with real players** - Register actual Discord users

### Testing with Your Discord ID

Update `db/seed.sql`:

```sql
INSERT INTO players (discord_id, discord_username, league) VALUES
('YOUR_DISCORD_ID', 'YourName', 'Academy')
ON CONFLICT (discord_id) DO NOTHING;
```

Then:
```bash
docker exec -i tm-scrim-db psql -U tmscrim -d tmscrim < db/seed.sql
```

Now when you use `/queue join`, you'll receive actual DMs!

## Customizing Notifications

### Embed Colors

In `src/handlers/queueEvents.ts`:
- Queue pop: `0x00FF00` (green)
- Dodge penalty: `0xFF0000` (red)
- Match cancelled: `0xFFA500` (orange)

### Message Content

All message text is in `handleQueuePop()` and `handleCheckInTimeout()`. Customize as needed!

### Form URL

The form URL is generated by `FormGenerator.generateFormUrl()` using environment variables. Make sure your `.env` has the correct:
- `GOOGLE_FORM_BASE_URL`
- `GOOGLE_FORM_*_ENTRY` IDs

## Monitoring

All events are logged at INFO level:
- `Handling queue pop`
- `Sent queue pop DM`
- `Handling check-in timeout`
- `Sent dodge penalty notification`
- `Sent match cancelled notification`

Check your logs to verify events are working correctly.
